{ "Fn::Base64": { "Fn::Sub": { "Fn::Join": [ "\n", [
  "#!/bin/bash -ex",
  "function finish { ",
  "  exit_code=${1:-99};",
  "  shift",
  "  /opt/aws/bin/cfn-signal -e $exit_code --stack ${AWS::StackName} --region ${AWS::Region} --resource 'ApplicationASG' $@; ",
  "  [[ $exit_code == 0 ]] && trap - EXIT ; ",
  "  exit $exit_code;",
  "}",
  "trap finish EXIT",
  "# get instance id for logging",
  "export INSTANCE_ID=\"`curl 169.254.169.254/latest/meta-data/instance-id`\"",
  "#determine whether we need no-include-email",
  "set +e; docker login -e  </dev/null >/dev/null; if [ $? == 125 ]; then incemail=--no-include-email;fi; set -e",
  "eval `aws --region ${AWS::Region} ecr get-login $incemail`",
  "# run application in daemonic mode",
  "docker run -d \\",
  "  --log-driver=awslogs \\",
  "    --log-opt tag=\"${Environment}-${ApplicationName}/$INSTANCE_ID/{{.ID}}\" \\",
  "    --log-opt awslogs-region=${AWS::Region} \\",
  "    --log-opt awslogs-group=${ApplicationLogGroup} \\",
  "  --restart=always",
  "  -e AWS_REGION=${AWS::Region} \\",
  "  -e AWS_STACK_NAME=${AWS::StackName} \\",
  "  -e AWS_STACK_ID=${AWS::StackId} \\",
  "# TODO:  environ file!!! \\",
  "# TODO: also would be convenient if the environment file would be made up \\",
  "# based on an SSM Parameters path \\",
  "${DockerPorts} \\", 
  "${DockerExtras} \\",
  "# don't forget this could have it's own refs to region etc \\",
  "${DockerImage} ",
  "finish 0"
] ] } } }
