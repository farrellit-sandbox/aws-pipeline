{ 
  "Parameters": {
    "AppSubnets": { "Type": "String", "Description": "(Really a CSV<SubnetId>)" },
    "LoadBalancerSubnets": { "Type": "String", "Description": "(Really a CSV<SubnetId>)" },
    "VpcId": {"Type": "String", "Description": "Really a AWS::EC2::VpcId" },
    "ApplicationName": {"Type": "String" , "Description": "Must be lowercase" },
    "ApplicationGroup": { "Type": "String","Description": "Must be lowercase"  },
    "AppDomainName": { "Type": "String" },
    "AppValidationDomain": { "Type": "String" },
    "Environment": { "Type": "String" },
    "LogRetentionInDays": { "Type": "Number", "Default": "14" },
    "ImageId": { "Type": "String" },
    "GithubOwner": { "Type": "String", "Default": "" },
    "GithubRepo": { "Type": "String", "Default": "" },
    "GithubBranch": { "Type": "String", "Default": "master" },
    "SourceRepository": { "Type": "String", "Description": "Applies when we're not building it ourself", "Default": "" },
    "SourceRepositoryArn": { "Type": "String", "Description": "How could we figure this out", "Default": "" },
    "DockerDir": { "Type": "String", "Default": "." },
    "DockerFile": { "Type": "String", "Default": "Dockerfile" },
    "RepositoryName": { "Type": "String", "Default": "" },
    "DelegationZoneId": { "Type": "String", "Default": "", "Description": "So delegation records can be created" },
    "DelegationZone": { "Type": "String", "Default": "", "Description": "So delegation records can be created" },
    "DockerPort": {"Type": "String", "Default": "80", "Description": "Open this port for the docker container" }
  },
  "Conditions": {
    "Debug": { "Fn::Equals": [ "True", "False" ] },
    "UseRepositoryName": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "RepositoryName" }, "" ] } ] },
    "HasSourceRepository": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "SourceRepository" }, "" ] } ] }
  },
  "Resources": {
    "ImageRepo": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": { "Fn::If": [ "UseRepositoryName", { "Ref": "RepositoryName" }, { "Fn::Sub": "${ApplicationGroup}/${ApplicationName}" } ]  }
      }
    },
    "ApplicationBuildPolicy": {
      "Type" : "AWS::IAM::ManagedPolicy",
      "Properties" : {
        "Description" : "Access the repositories",
        "Path" : "/build/docker/",
        "PolicyDocument" :   {
          "Version":"2012-10-17", 
          "Statement" : [
            {
              "Action": [ "ecr:GetAuthorizationToken" ],
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "NotAction": [
                "ecr:Delete*",
                "ecr:Put*Policy",
                "ecr:Set*Policy"
              ],
              "Effect": "Allow",
              "Resource": [ { "Fn::Sub": "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/${ImageRepo}" } ] 
            },
            { "Fn::If": [ "HasSourceRepository", 
             {
              "Action": [
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:GetDownloadUrlForLayer"
              ],
              "Effect": "Allow",
              "Resource":  { "Ref": "SourceRepositoryArn" }
             },
             { "Ref": "AWS::NoValue" }
            ] }
          ]
        }
      }
    },
    "ApplicationDockerPipeline": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": { 
        "TemplateURL": "file://templates/pipeline.json",
        "Parameters": {
          "BuildPolicyArns": { "Ref": "ApplicationBuildPolicy" },
          "ProjectName": { "Fn::Sub": "${ApplicationGroup}-${ApplicationName}" },
          "GithubOwner": {  "Ref": "GithubOwner" },
          "GithubRepo": { "Ref": "GithubRepo" },
          "GithubBranch": { "Ref": "GithubBranch" },
          "SiteTemplate": "",
          "SelfDeployPipeline": "False",
          "BuildImage": "aws/codebuild/docker:17.09.0",
          "BuildSpec": { "Fn::Join": [ "\n", [
            "version: 0.2",
            "phases:",
            " install:",
            "  commands:",
            "  - aws ecr get-login --no-include-email | sh" , 
            { "Fn::If": [ "HasSourceRepository", { "Fn::Join": [ "\n", [
            { "Fn::Sub": "  - docker pull ${SourceRepository}:$CODEBUILD_RESOLVED_SOURCE_VERSION" },
            { "Fn::Sub":["  - docker tag  ${SourceRepository}:$CODEBUILD_RESOLVED_SOURCE_VERSION ${TargetRepo}:$CODEBUILD_RESOLVED_SOURCE_VERSION" , { "TargetRepo": { "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ImageRepo}" } } ] }
            ] ] }, 
            { "Fn::Sub":["  - docker build -t ${TargetRepo}:$CODEBUILD_RESOLVED_SOURCE_VERSION -f ${DockerFile} ${DockerDir}", { "TargetRepo": { "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ImageRepo}" } } ] }
            ] },
            
            { "Fn::Sub":["  - docker push ${TargetRepo}:$CODEBUILD_RESOLVED_SOURCE_VERSION", { "TargetRepo": { "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ImageRepo}" } } ] }
          ] ] }
        }
      }
    },
    "LogGroup": {   
      "Properties": {
        "LogGroupName": { "Fn::Sub": "X-${Environment}-${ApplicationName}" },
        "RetentionInDays": { "Ref": "LogRetentionInDays" }
      },
      "Type": "AWS::Logs::LogGroup"
    },
    "HostedZone": {
      "Type": "AWS::CloudFormation::Stack", 
      "Properties": {
        "TemplateURL": "file://templates/zone.json",
        "Parameters": {
          "DomainName": { "Ref": "AppDomainName" },
          "ApplicationName": { "Ref": "ApplicationName" },
          "ApplicationGroup": { "Ref": "ApplicationGroup" },
          "Environment": { "Ref": "Environment" },
          "DelegationZoneId": { "Ref": "DelegationZoneId"},
          "DelegationZone": { "Ref": "DelegationZone"}
        }
      }
    },
    "ALB": { 
      "Type": "AWS::CloudFormation::Stack", 
      "Properties": {
        "TemplateURL": "file://templates/alb.json",
        "Parameters": {
          "ApplicationName": { "Ref": "ApplicationName" },
          "Environment": { "Ref": "Environment" },
          "Subnets": { "Ref": "LoadBalancerSubnets" },
          "VpcId": { "Ref": "VpcId" },
          "DomainName": { "Ref": "AppDomainName" },
          "ValidationDomain": { "Ref": "AppValidationDomain" },
          "HostedZoneId": { "Fn::GetAtt": [ "HostedZone", "Outputs.HostedZoneId" ] } 
        }
      }
    },
    "ApplicationASG": {
      "Type": "AWS::CloudFormation::Stack", 
      "Properties": {
        "TemplateURL": "file://templates/asg.json",
        "Parameters": {
          "ApplicationName": { "Ref": "ApplicationName" },
          "Environment": { "Ref": "Environment" },
          "AppSubnets": { "Ref": "AppSubnets" },
          "DockerPort": { "Ref": "DockerPort" },
          "RepositoryName": { "Ref": "ImageRepo" },
          "ImageTag": "latest",
          "ImageId": { "Ref": "ImageId" },
          "LogGroupName": { "Ref": "LogGroup" },
          "LogGroupArn": { "Fn::GetAtt": [ "LogGroup", "Arn" ] },
          "TargetSecurityGroup": { "Fn::GetAtt": [ "ALB", "Outputs.BackendSecurityGroup" ] },
          "TargetGroupArns": { "Fn::GetAtt": [ "ALB", "Outputs.TargetGroupArn" ] }
        }
      }
    }
  }
}
