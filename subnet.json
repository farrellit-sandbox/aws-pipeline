{
  "Parameters": { 
    "VpcId": { "Type": "AWS::EC2::VpcId" },
    "AvailabilityZone": { "Type": "String" },
    "Group": { "Type": "String" },
    "ExternalCidr":  { "Type": "String" },
    "PrivateCidr": { "Type": "String" },
    "Zone": { "Type": "String", "Description": "The letter representing the zone, typically within [a-f]" }, 
    "NatGateway": { "Type": "String", "Description": "In case we're sharing across AZs", "Default": "" },
    "InternetGateway": { "Type": "String", "Description": "Assuming we're sharing this" },
    "ExternalRouteTable": { "Type": "String", "Description": "Assumedly there'd be a public route table to share but we could create it here" },
    "NetworkName": { "Type": "String" },
    "Environment": { "Type": "String" },
    "AllowInternalInternetAccess": { "Type":, "String", "Default": "True" }
  },
  "Conditions": { 
    "CreateNat": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "NatGateway" }, "" ] } ] },
    "InternalInternetAccess": { "Fn::Equals": [ { "Ref": "AllowInternalInternetAccess" }, "True" ] }
  },
  "Resources": {
    "ExternalSubnet": {
      "Properties": {
        "AvailabilityZone": { "Fn::Join": [ "", [ { "Ref": "AWS::Region" }, { "Ref": "Zone" } ] ] },
        "CidrBlock": { "Ref": "ExternalCidr" },
        "Tags": [
          { "Key": "env", "Value": { "Ref": "Environment" } },
          { "Key": "tier", "Value": "external" },
          { "Key": "network", "Value": { "Ref": "NetworkName" } }
        ],
        "VpcId": { "Ref": "Vpcid" },
        "MapPublicIpOnLaunch": true
      },
      "Type": "AWS::EC2::Subnet"
    },
    "ExternalRouteTableAssociation": {
      "Properties": {
        "RouteTableId": { "Ref": "ExternalRouteTable" },
        "SubnetId": { "Ref": "ExternalSubnet" }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "InternalSubnet": {
     "Ref": "NatGateway" },   "Properties": {
        "AvailabilityZone": { "Fn::Join": [ "", [ { "Ref": "AWS::Region" }, { "Ref": "Zone" } ] ] },
        "CidrBlock": { "InternalCidr" },
        "Tags": [
          { "Key": "env", "Value": { "Ref": "Environment" } },
          { "Key": "tier", "Value": "internal" },
          { "Key": "network", "Value": { "Ref": "NetworkName" } }
        ],
          "VpcId": { "Ref": "Vpcid" },
          "MapPublicIpOnLaunch": false
        },
        "Type": "AWS::EC2::Subnet"
    },
    "DedicatedNatGatweayEIP": {
      "Condition": "CreateNat" , 
      "Properties": {
        "Domain": "vpc"
      },
      "Type": "AWS::EC2::EIP"
    }, 
    "DedicatedNatGateway": { 
      "Condition": "CreateNat" , 
      "Properties": {
        "AllocationId": { "Fn::GetAtt": [ "NatGatewayEIP", "AllocationId" ] },
        "SubnetId": { "Ref": "ExternalSubnet" }
      },
      "Type": "AWS::EC2::NatGateway"
    },
    "InternalRouteTable": {
      "Properties": {
        "VpcId": { "Ref": "VPC" } 
      },
      "Type": "AWS::EC2::RouteTable"
    },
    "InternalRouteTableAssociation": {
      "Properties": {
        "RouteTableId": { "Ref": "InternalRouteTable" },
        "SubnetId": { "Ref": "InternalSubnet" }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "InternalDefaultRoute": {
      "Condition": "InternalInternetAccess", 
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": { "Fn::If": [ "CreateNat", { "Ref": "DedicatedNatGateway" }, "{ "Ref": "NatGateway" } ] }, 
        "RouteTableId": { "Ref": "ZoneAPrivateRoutingTable" }
      },
      "Type": "AWS::EC2::Route"
    }
  }
}
